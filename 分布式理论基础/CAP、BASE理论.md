# CAP

## **一、CAP 理论定义**

CAP 理论由加州大学伯克利分校的 Eric Brewer 在 2000 年提出：

> **在一个分布式系统中，最多只能同时满足下面三个中的两个：**

- > **C**: Consistency（一致性）

- > **A**: Availability（可用性）

- > **P**: Partition tolerance（分区容忍性）

换句话说，当网络分区（Partition）发生时，一个分布式系统**只能在“可用性”和“一致性”之间做权衡**。



## **二、三个术语的准确含义**

| **缩写**         | **中文** | **精确定义**                                           | **示例说明**                                               |
| ---------------- | -------- | ------------------------------------------------------ | ---------------------------------------------------------- |
| **C - 一致性**   | 一致性   | 所有节点访问同一份最新的数据副本                       | 类似于单机数据库中的强一致性（如写入成功，所有读都能读到） |
| **A - 可用性**   | 可用性   | 系统对外始终能提供响应，且不会报错                     | 哪怕返回的数据不是最新的，只要响应了就算“可用”             |
| **P - 分区容忍** | 分区容错 | 系统可以容忍任意消息丢失或延迟的网络故障（网络不可达） | 任意两个节点之间出现网络问题，系统仍能继续对外提供服务     |

> 🔥 关键点：**分布式系统中** 网络分区是**必然会发生**的，因此 P 必须具备。



## **三、CAP 三选二的本质逻辑**

由于 P 是不可避免的，**实际上 CAP 理论就是告诉你必须在 C 和 A 之间做权衡**：



### CP 系统：一致性 + 分区容忍

- 当网络分区时，为了保持一致性，部分服务将不可用（暂停响应）
- **场景举例**：Zookeeper、Etcd、HBase
- **特性**：宁可不提供服务，也不能返回错误数据

> ✅ 优点：数据强一致性

> ❌ 缺点：极端情况下可能导致服务不可用（如主节点选举中）



### AP 系统：可用性 + 分区容忍

- 系统持续对外提供响应，但不能保证返回的是最新的、全局一致的数据
- **场景举例**：Cassandra、Eureka、Dubbo 注册中心
- **特性**：倾向于“最终一致性”，弱化强一致性要求

> ✅ 优点：系统高可用性强，响应不挂掉

> ❌ 缺点：客户端可能读取到旧数据或不同节点数据不一致



### CA 系统：一致性 + 可用性（但不能容忍分区）

- 这种系统在**单机或网络永远正常**的前提下可以实现，但在分布式场景下**理论上无法实现**
- **场景举例**：传统单体数据库系统（如 MySQL 单机）





## **四、CAP 实践意义与工程落地**

在实际工程中，我们**不能把 CAP 理论作为一种“选项卡”，说我选 CP 或 AP，而是按业务需求做分布式设计权衡**：

| **场景**       | **更倾向**                       |
| -------------- | -------------------------------- |
| 金融、订单系统 | CP：牺牲可用性换取一致性         |
| 社交、日志系统 | AP：只要服务不挂，允许延迟一致   |
| 注册中心       | AP：即便某节点挂掉，也能服务发现 |

同时出现了 **BASE 理论** 来补充 CAP：

> **BASE = Basically Available + Soft state + Eventually consistent**

> 强调“最终一致性”而不是“强一致性”。



## **五、CAP 和分布式事务、锁之间的关系（提前一点串联）**

- CAP 是分布式的核心问题建模模型
- **分布式事务协议**（如 2PC、TCC、SAGA）是为了解决 C
- **分布式锁/一致性协议**（如 Raft、Paxos）是为了解决 CP 的问题
- **消息中间件 + 异步补偿**（如 Kafka、RocketMQ）是为了解决 AP 的问题



## **六、典型面试问法**

1. 你能解释一下 CAP 理论吗？
2. 如果发生网络分区，分布式系统如何在一致性和可用性之间做取舍？
3. Eureka 是怎么选的？为什么是 AP 而不是 CP？
4. Zookeeper 是 CP 系统，那它怎么处理脑裂问题？



# BASE

**BASE 理论**是对 CAP 理论在工程实践中的一种“妥协式补充方案”。理解它有助于你掌握“如何在牺牲强一致性的同时，保持系统整体的可用性和最终一致性”。



## **一、BASE 理论定义**

BASE 是三个英文单词的缩写：

| **缩写** | **含义**              | **解释**                                                     |
| -------- | --------------------- | ------------------------------------------------------------ |
| **B**    | Basically Available   | 基本可用，系统在出现故障时，允许一定程度的功能损失（如响应延迟、降级） |
| **A**    | Soft State            | 软状态，允许系统中存在中间状态（非强一致）且不会立即影响整体正确性 |
| **SE**   | Eventually Consistent | 最终一致，系统不保证实时一致，但在一段时间后所有副本都会达到一致状态 |

> 🔥 BASE 理论的核心就是：“在 CAP 不可三全的约束下，牺牲强一致性，换取系统的高可用和分区容错。”



## **二、与 CAP 的对比**

| **理论** | **主张**                       | **强调重点** | **工程取向**                     |
| -------- | ------------------------------ | ------------ | -------------------------------- |
| CAP      | 强一致性 or 高可用（不能兼得） | 理论框架     | 学术性更强                       |
| BASE     | 弱一致性，服务不可阻断         | 实践妥协     | 工程实用派，更贴近互联网系统场景 |



## **三、BASE 的三个核心理念详解**



### **1. Basically Available（基本可用）**

系统即使部分失败，也能对外提供“部分服务”或“降级响应”。

- 如：请求超时后返回兜底值 / 错误提示页面
- 常见机制：
  - 服务降级（Hystrix、Sentinel）
  - 熔断机制（Circuit Breaker）
  - 限流（令牌桶、漏桶）

**例子：** 电商抢购，订单服务扛不住时，只提示“当前抢购人数过多，请稍后再试”，不挂服务。



### **2. Soft State（软状态）**

系统状态可以是**中间状态**，这与强一致性不同，允许数据在传播过程中的短暂不一致。

- 不要求每次写入都立即反映在所有副本上
- 数据可以延迟同步、异步修复
- 比如：
  - 缓存未命中时去数据库查（状态不一致）
  - 依赖异步消息队列进行数据同步



### **3. Eventually Consistent（最终一致性）**

不保证强一致性，只保证数据**最终会达到一致状态**，常配合幂等和重试机制。

- 适用于非强一致要求的场景，如：
  - 订单状态变更
  - 用户信息异步同步
  - 写入 DB 后异步同步至 ES

> 这不是“永远不一致”，而是容忍“短时间不一致”。



## **四、BASE 理论落地方式**



| **方法**            | **说明**                                 | **关键词**           |
| ------------------- | ---------------------------------------- | -------------------- |
| 异步消息队列        | 通过 Kafka/RocketMQ 做服务解耦、异步写入 | 延迟同步、最终一致   |
| 读写分离 + 数据同步 | 写入主库，读从库，存在同步延迟           | 数据版本、延迟一致性 |
| 分布式事务补偿      | 利用 TCC/SAGA/幂等重试保障数据收敛       | 补偿、幂等、失败处理 |
| 缓存更新策略        | 允许缓存和数据库短时间不一致             | 延迟双删、消息同步   |



## **五、实际工程中的应用场景**

| **场景**        | **BASE 实践手段**             |
| --------------- | ----------------------------- |
| 高并发秒杀      | 降级 + 限流 + 缓存兜底        |
| 注册/下单等流程 | 消息队列异步写 ES、异步发邮件 |
| 多服务数据一致  | TCC、SAGA、可靠消息最终一致性 |



## **六、常见面试问法**

1. 你能解释 BASE 理论吗？和 CAP 有什么区别？
2. 系统如何实现最终一致性？用过哪些策略？
3. 下单成功后异步写入 ES，这样怎么保证最终一致性？
4. 异步 MQ 场景下怎么防止消息丢失？保证幂等性？



## **七、总结一句话**

> **BASE 理论强调“系统总要活着”，哪怕短时间内数据不一致，也要保证系统持续可用，数据最终一致。**