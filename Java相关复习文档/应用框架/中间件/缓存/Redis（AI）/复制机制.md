# **一、PSYNC 与部分重同步**

### **1. replid / offset**

- **replid**：复制 ID，每个主节点启动时生成一个唯一标识。
- **offset**：偏移量，表示主节点复制流中命令的位置。
- 从节点会记录 (master_replid, offset)，用来和主节点对齐。



### **2. 复制积压缓冲区（Replication Backlog）**

- 主节点维护一个**固定大小的环形缓冲区**（默认 1MB）。
- 缓冲区里保存最近一段时间的复制命令。
- 当从节点短暂掉线，再次连接时，如果它的 offset 仍在 backlog 范围内，就能直接进行**部分重同步**。
- 如果 offset 太旧不在 backlog 内，就只能做**全量同步**。



### **3. PSYNC**

- Redis 2.8+ 引入 PSYNC，支持**部分重同步**。

- 从节点发送 PSYNC replid offset，主节点判断能否从 backlog 续上：

  - 能续：只发缺失的命令（部分同步）。
  - 不能：触发全量同步。

  

# **二、全量同步流程**

当 backlog 不够用，或新从节点第一次加入，就会触发**全量同步**：

1. **握手**：从节点发送 PSYNC ? -1 请求全量。

2. **主节点生成 RDB**：

   - fork() 子进程生成 RDB 文件（磁盘或内存）。
   - 在这期间，新的写命令会写到**复制缓冲区**，避免丢失。

   

3. **传输 RDB**：主节点把 RDB 发送给从节点。

   - **磁盘复制**：先写到磁盘，再读给从节点。
   - **无盘复制（diskless replication）**：直接通过 pipe/socket 传输给从节点（减少磁盘 IO）。

   

4. **加载 RDB**：从节点清空旧数据，加载新的 RDB。

5. **命令流追赶**：再接收并执行主节点在 RDB 生成期间积压的命令，追上主节点进度。

6. **进入稳定复制**：之后实时接收命令流。

# **三、延迟与一致性**

### **1. 异步复制**

- Redis 复制默认是**异步的**：主节点执行写命令后就直接返回客户端，不等待从节点确认。
- 优点：延迟低。
- 缺点：如果主节点宕机，而从节点还没收到最新命令 → **数据丢失**。



### **2. WAIT 命令（半同步）**

```
WAIT numreplicas timeout
```

- 作用：强制等待写入传播到至少 numreplicas 个从节点。
- 返回：确认写入的副本数。
- 用途：提升一致性保证，但会带来额外延迟。



# **四、安全写机制**

Redis 提供一些配置项来避免主节点“独自写太久”，从而防止数据安全隐患：



### **1. min-replicas-to-write**

- 配置主节点必须检测到至少多少个从节点是“健康的”，否则拒绝写。
- 健康 = 从节点复制延迟在可接受范围内。



### **2. min-replicas-max-lag**

- 配合上面使用：定义“最大延迟时间阈值（秒）”。
- 如果从节点落后太多，就不算“健康”。



**例子**：

```
min-replicas-to-write 2
min-replicas-max-lag 10
```

含义：至少有 2 个从节点延迟 ≤10 秒，主节点才会继续接受写请求。

否则返回写失败，保证数据不会只存在单点。



# **五、总结**

- **PSYNC** + **backlog** = 大多数场景下只需部分同步，避免频繁全量。
- **全量同步** = RDB 传输 + 命令流追赶，可选无盘复制优化性能。
- **异步复制** = 高性能但有一致性风险，可用 WAIT 提升安全。
- **安全写** = min-replicas-to-write + min-replicas-max-lag，避免主节点单点写入风险。



✅ 一句话总结：

Redis 的复制默认是**异步**的，通过 **replid/offset + backlog** 实现高效的部分重同步；全量同步依赖 RDB + 命令流追赶；一致性风险可用 WAIT 或安全写参数缓解，但无法像数据库那样强一致。