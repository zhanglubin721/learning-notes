# 1. 基本概念与整体架构

- 角色与术语

  - Producer / Consumer / Broker / NameServer / (5.x) Proxy
  - Topic / MessageQueue(Queue) / Tag / Key / MessageId / Offset
  - Cluster / BrokerName / BrokerId / Group（Producer/Consumer）

  

- 工作流程总览

  - 发送路径（客户端 → NameServer 路由发现 → Broker 写入）
  - 消费路径（Pull/Push/POP → Rebalance → 处理 → 提交位点）
  - 元数据与路由（TopicRouteData、BrokerData）

  

- 典型部署拓扑

  - 多 Master、多 Master-Slave、DLedger（多副本 Raft）
  - 单/多 NameServer、跨机房/多可用区

  





# **2. 组件与交互机制**

- NameServer

  - 无状态、注册表、心跳与路由表、故障剔除

  

- Broker

  - 接口：SendMessage / PullMessage / POP / Ack / Admin
  - 线程池与队列、磁盘存储子系统、HA 同步

  

- 客户端

  - DefaultMQProducer / TransactionMQProducer
  - DefaultMQPushConsumer / DefaultLitePullConsumer / POP 客户端
  - Rebalance 实现、心跳与定时任务

  

- (5.x) Proxy

  - 位置与用途、协议转换、连接汇聚、权限/限流

  





# **3. 主题、队列与路由**

- Topic & Queue 规划

  - Queue 数量与吞吐、顺序与局部有序、热分区

  

- 路由发现

  - NameServer 路由拉取、注册/注销、路由缓存

  

- 负载均衡（Producer/Consumer）

  - Producer 轮询队列/可达性退避
  - Consumer Rebalance：触发条件、稳定性

  

- Rebalance 策略

  - Averagely / AveragelyByCircle / ByMachineRoom / ByConfig

  



# **4. 消息模型与属性**

- 消息字段

  - Body / Properties（Keys、Tags、Delay、Transaction、ShardingKey…）

  

- 消息大小与限制

  - 单条大小限制、批量消息限制、压缩

  

- 标签与键

  - Tag 粗粒度过滤、Key 用于查询与追踪

  



# **5. 存储子系统（落盘/索引）**

- 文件结构

  - CommitLog（顺序追加）
  - ConsumeQueue（逻辑队列：物理偏移、消息大小、TagCode）
  - IndexFile（倒排哈希：Key→Offset）

  

- MappedFile & PageCache

  - 预热、零拷贝、内核页缓存机制

  

- 刷盘策略

  - SYNC_FLUSH / ASYNC_FLUSH、刷盘线程、刷盘间隔/页数

  

- 碎片与清理

  - 文件切分大小、删除策略（保留天数/磁盘占用比）

  

- 校验与恢复

  - Broker 启动恢复、ConsumeQueue 重建、Index 重建

  





# **6. 发送模型与可靠性**

- 发送模式

  - 同步 / 异步 / Oneway / 批量发送

  

- 路由选队列算法

  - 轮询、故障规避（可用性退避/延迟规避）

  

- 发送重试与退避

  - 客户端重试次数、超时、失败降级

  

- 交付语义（生产侧）

  - 至少一次保障、可能重复、失败处理

  





# **7. 消费模型与位点管理**

- 消费模式

  - 集群（Cluster）/ 广播（Broadcast）
  - Push（长轮询）/ Pull / LitePull / POP（可见性超时+ACK）

  

- 位点管理

  - Broker 端存储 vs 本地、从何处开始（LAST/FIRST/TIMESTAMP）

  

- 并发控制

  - 消费线程池、批量拉取/批量消费、消费超时

  

- 重平衡细节

  - 触发时机：成员变更/队列变更/心跳/订阅变更
  - 阻塞与抖动治理

  





# **8. 顺序消息（有序与局部有序）**

- 生产侧分片

  - ShardingKey → 固定队列、负载热点

  

- 消费侧锁

  - Queue 级别串行、队列锁获取/续约

  

- 乱序原因与治理

  - 重平衡、失败重试、并发度设置

  





# **9. 事务消息（两阶段）**

- Half Message（预提交）

  - RMQ_SYS_TRANS_HALF_TOPIC / OpTopic

  

- 本地事务与回查

  - 事务执行器、状态提交/回滚、定时回查

  

- 幂等保证配合

  - 业务去重、对账与补偿

  

- 失败/卡死场景

  - Check 超时策略、生产者存活性要求

  





# **10. 延时/定时消息**

- Delay Level（4.x）

  - 级别映射、SCHEDULE_TOPIC_XXXX、轮询投递

  

- 精准定时（5.x Timer）

  - TimerWheel、时间槽、checkpoint

  

- 大量定时堆积治理

  - 分桶/散列策略、写放大与清理

  





# **11. 过滤与订阅表达式**

- Tag 过滤

  - Broker 端粗过滤、客户端细过滤

  

- SQL92 过滤

  - 属性过滤、Bloom/索引开销

  

- 过滤执行位置

  - 服务端/客户端、性能与一致性取舍

  





# **12. 重试、死信与回溯**

- 消费失败重试

  - reconsumeTimes、重试主题 %RETRY%Group

  

- 死信队列

  - %DLQ%Group、人工/自动处理策略

  

- 位点回溯

  - 时间回溯、精度与副作用（重复消费）

  



# **13. 流控、背压与堆积治理**

- 生产端限流

  - 超时、并发、发送 TPS 限制

  

- Broker 侧保护

  - 磁盘水位保护、PageCache 忙、拒绝策略

  

- 消费端背压

  - 拉取阈值、在途消息、队列级限流

  

- 堆积排障路径

  - 找队列/找组/看位点差/线程池/耗时分布

  



# **14. 高可用与复制**

- 主从模式

  - SYNC_MASTER/ASYNC_MASTER/SLAVE

  

- HAService

  - 复制链路、落后追赶、ACK 语义

  

- DLedger（Raft）

  - Leader/Follower/Candidate、选举、提交索引

  

- 容灾与跨 AZ

  - 写入路由策略、读写分离、IDC 隔离

  



# **15. 安全与权限**

- ACL

  - AccessKey/SecretKey、白名单、权限矩阵（PUB/SUB/ADMIN）

  

- 传输安全

  - TLS/SSL、证书配置

  

- Proxy 层安全（5.x）

  - 鉴权与限流、审计

  



# **16. 监控、可观测性与排障**

- 指标与日志

  - 发送/消费 TPS、RT、堆积量、拒绝/失败
  - Broker/Client 运行日志、异常码定位

  

- RocketMQ Console

  - 集群/Topic/消费进度/堆积/查询

  

- Prometheus/Grafana

  - Exporter 指标、告警项

  

- 消息轨迹

  - Trace 插件、轨迹字段、端到端排障

  

- 常用排障工具链

  - mqadmin：topicRoute/clusterList/brokerStatus/queryMsgById/Key/resetOffset…

  



# **17. 运维与治理**

- Topic/Group 生命周期

  - 创建/修改/权限、订阅一致性检查

  

- 配置热更新

  - Broker/Topic/Group 参数动态更新

  

- 数据清理与恢复

  - CommitLog/CQ 删除策略、CQ 重建、Index 重建

  

- 消息迁移与扩容

  - 扩队列数影响（有序/均衡）、跨集群迁移

  

- 版本升级

  - 4.x→5.x 路线、客户端兼容、灰度策略

  



# **18. 性能与参数调优（服务端/客户端/OS）**

- Broker 核心参数

  - flushDiskType、transientStorePool、maxMessageSize
  - commitLog 文件大小、删除阈值、刷盘间隔/页数
  - sendMessageThreadPool、pullThreadPool、popThreadPool

  

- 客户端核心参数

  - sendMsgTimeout、retryTimes、compress、batchSize
  - 消费线程池、拉取阈值、批量大小、消费超时

  

- OS & JVM

  - 文件描述符、内核参数、numa/磁盘/IO 调优、JVM 垃圾回收选择

  

- 基准测试与压测

  - 发送吞吐、端到端延迟、持久化 RT、失败率

  



# **19. POP 消费（可见性超时）**

- POP 基本语义

  - pop / ack / invisibilityTimeout、Revive 服务

  

- 重试与 DLQ

  - popRetry 主题、ack 超时重投

  

- 与 Push/Pull 对比

  - 无位点、幂等要求、服务端压力模型

  



# **20. 事务/幂等等价与业务设计**

- 至少一次与重复

  - 幂等 Key、去重表/缓存、语义性补偿

  

- 事务消息最佳实践

  - 本地事务原子性、回查接口健壮性、反查防抖

  



# **21. 对比与选型（高频面试对比题）**

- 与 Kafka

  - 存储（CQ vs Segment+Index）、消费模型（Push/POP vs Pull）、顺序/事务/延时

  

- 与 RabbitMQ

  - 路由模型、事务/确认、延时机制、吞吐与定位

  

- 适用场景

  - 高吞吐可扩展、定时/事务/顺序要求、跨语言

  



# **22. Spring 与生态集成**

- rocketmq-spring

  - 注解驱动、消息转换器、事务整合、重试配置

  

- Connect / Connector

  - Source/Sink、数据集成

  

- Kubernetes

  - RocketMQ-Operator（NameService/Broker/Topic CRD）、有状态运维

  

- 其他客户端

  - Java/Go/C++/Python、协议兼容

  



# **23. 常见考点陷阱与易错题**

- “Exactly once” 是否支持、如何实现业务幂等
- 顺序消息与扩分区的矛盾、重平衡导致乱序
- 延时堆积导致写放大/调度延迟
- DLedger 与多 Master 差异、跨机房一致性取舍
- 重试/死信与业务重放的副作用
- SQL 过滤与性能成本、过滤在哪里执行
- Broker 磁盘水位保护导致“写拒绝”的排查路径
- POP 可见性超时导致的“重复/漏 ACK”场景





# **24. 常用 mqadmin/Console 操作面**

- 主题/分组

  - updateTopic、updateSubGroup、topicStatus、topicRoute

  

- 集群/Broker

  - clusterList、brokerStatus、updateBrokerConfig、wipeWritePerm

  

- 查询与故障处理

  - queryMsgById/Key、messageTrack、resetOffsetByTime、cloneGroupOffset

  

- 压测与工具

  - producer/consumer 性能测试工具、导入导出脚本

  



# **25. 升级与版本特性（面试追问点）**

- 4.x → 5.x 变化

  - Proxy 引入、POP 增强、Timer 重构（精准定时）、协议演进

  

- 向下兼容

  - 4.x 客户端与 5.x Broker/Proxy 互通边界

  

- 社区热点

  - DLedger 成熟度、SQL 过滤优化、遥测指标标准化

  





# **26. 场景题要点（设计/排障提纲）**

- 海量定时订单

  - 精准定时、分桶、回压与清理策略

  

- 交易与库存

  - 事务消息+幂等、补偿回查、恶劣网络

  

- 日志/埋点

  - 批量发送、压缩、异步吞吐、落地合规

  

- 堆积突发

  - 扩消费者/并发、跳过慢队列、临时加速策略

  

- 跨地域多活

  - 双写一致性、读写路由、回放与对账

  





# **27. 关键类与源码锚点（便于你深挖）**

- 存储

  - CommitLog / MappedFile / MappedFileQueue / DefaultMessageStore
  - ConsumeQueue / IndexFile / HAService / DLedgerCommitLog
  - ScheduleMessageService / TimerMessageStore

  

- 服务端处理器

  - SendMessageProcessor / PullMessageProcessor / PopMessageProcessor / AckMessageProcessor
  - AdminBrokerProcessor / ClientManageProcessor

  

- 客户端

  - MQClientInstance / RebalanceImpl / PullAPIWrapper
  - DefaultMQProducerImpl / DefaultMQPushConsumerImpl
  - TransactionMQProducer、TransactionalMessageServiceImpl

  





# **28. 参数名速查（常被问“说几个关键参数”）**

- Broker

  - flushDiskType、brokerRole、deleteWhen、fileReservedTime、diskMaxUsedSpaceRatio
  - maxMessageSize、transientStorePoolEnable、flushLeastPages、flushIntervalCommitLog

  

- Client（Producer/Consumer）

  - sendMsgTimeout、retryTimesWhenSendFailed、retryTimesWhenSendAsyncFailed、compressMsgBodyOverHowmuch
  - consumeMessageBatchMaxSize、pullBatchSize、consumeThreadMin/Max、consumeTimeout

  



# **29. 常见面试追问清单（一口气列题）**

- 为什么 RocketMQ 能高吞吐？（顺序写、PageCache、零拷贝…）
- 至少一次如何落地？如何避免“重复扣减”？
- 顺序消息如何扩容不乱序？遇到 Rebalance 怎么办？
- 事务消息回查什么时候触发？Half/Op 主题作用？
- 延时消息 4.x 与 5.x 差异？为什么要 TimerWheel？
- POP 的 ACK 语义与可见性超时如何配置？和 Push 区别？
- DLedger 的“提交点”与读写一致性怎么权衡？
- SQL 过滤在 Broker/Client 的性能差异与边界？
- NameServer 如何做路由剔除与收敛？
- 堆积排查 5 步法（谁慢/哪里慢/为什么慢/如何解/副作用）