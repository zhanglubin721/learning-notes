# **1) 核心角色（Producer / Consumer / Broker / NameServer / Proxy[5.x]）**

- Producer（生产者）

  - 定义：发送消息的客户端进程（Java 常见类：DefaultMQProducer、TransactionMQProducer）。
  - 作用边界：负责路由发现→选队列→编码消息→发送（同步/异步/单向/批量）；失败重试与故障规避只保证“尽力送达”，不保证幂等。
  - 实现锚点：客户端维持到 **多个 Broker** 的连接与心跳；“延迟容错发送”会避开近期慢/失败的 Broker 队列。
  - 面试易错：Producer Group 不是“分片键”，而是事务回查与重试主题命名等语义锚点（见第 3 组“Group”）。

  

- Consumer（消费者）

  - 定义：消费消息的客户端进程（DefaultMQPushConsumer、DefaultLitePullConsumer、POP 客户端）。
  - 作用边界：拉取/接收→并发处理→提交位点（Cluster 模式位点在 Broker，Broadcast 多为本地）；参与 **Rebalance** 获取一组 MessageQueue 的所有权。
  - 消费模型：Push（长轮询）、Pull（自主拉取）、LitePull（更细控制）、POP（5.x，可见性超时 + ACK）。
  - 面试易错：**“Push”并不是服务端推送**，本质上还是客户端长轮询拉取；POP 模式**没有队列位点**，靠“可见性超时 + ack receipt”。

  

- Broker（消息服务器）

  - 定义：持久化与投递的核心节点（Master/Slave；或 DLedger/Controller 领导者）。
  - 作用边界：写入 CommitLog、构建 ConsumeQueue/Index、处理 Send/Pull/POP/Ack/Admin、保存消费位点（Cluster）、维护重试/死信主题。
  - HA：传统主从（异步/同步）或基于 DLedger/Raft 的多副本。
  - 面试易错：顺序消费的“顺序”是 **单个 MessageQueue 内的局部顺序**；跨队列天然不保证。

  

- NameServer（路由注册中心）

  - 定义：**无状态**路由服务，每个 Broker 定期向所有 NameServer 注册；客户端从任一 NameServer 拉取路由。
  - 作用边界：只维护“谁提供了某个 Topic 的哪些队列”；不做一致性选主、不转发数据流量、无跨 NS 协调。
  - 面试易错：NameServer 全挂了并不立刻“瘫痪”——客户端有本地路由缓存，会在过期后退化；但路由变更将不可见。

  

- Proxy（5.x 可选）

  - 定义：位于客户端与 Broker 之间的接入层（协议/连接汇聚、鉴权、限流、POP/Timer 协议卸载等）。
  - 作用边界：统一接入与安全、减少直连 Broker 的连接数、便于多语言/网关化；业务语义仍在 Broker 落地。
  - 面试易错：Proxy 不是 NameServer 的替代；也不是“必需要”，但**在大规模与多语言场景显著简化接入**。

  







# **2) 消息与路由术语（Topic / MessageQueue / Tag / Key / MessageId / Offset）**

- Topic

  - 定义：消息分类的 **逻辑命名空间**。
  - 结构：一个 Topic 在多个 Broker 上按 **队列（MessageQueue）** 切分（queueId 0..N-1）。
  - 权限：读/写权限可分别配置；不同集群可同名但互相隔离。
  - 易错：**顺序语义依赖“固定分片策略”**（生产按 ShardingKey 选定队列，消费单队列串行）。

  

- MessageQueue（Queue / 分区）

  - 定义：Topic 内的 **最小负载与顺序单元**，由 (topic, brokerName, queueId) 唯一标识。
  - 生产：Producer 选队列（轮询/故障规避/按键映射）。
  - 消费：ConsumerGroup 在 Rebalance 后领取一组队列的“所有权”；同一时刻一个队列只属于一个消费实例（Cluster 模式）。
  - 易错：扩队列数会**打散历史顺序**；要维持有序需预留足够分片并固化 ShardingKey→queue 的映射。

  

- Tag

  - 定义：消息的 **粗粒度标签**（单值/OR 表达式）；在 ConsumeQueue 中以 tagCode（hash）存储，Broker 端可做初筛。
  - 作用：降低无效投递；更细粒度过滤请用 SQL92 过滤（基于 properties）。
  - 易错：Tag 过滤是**粗过滤**，仍可能下发到客户端后再细判；SQL 过滤则增加 Broker 侧负担（权衡性能）。

  

- Key（Business Key）

  - 定义：业务检索键（可多个）；写入 IndexFile，用于 **按 Key 查询/追踪**。
  - 作用：mqadmin queryMsgByKey、故障排查、轨迹对账。
  - 易错：Key 不是唯一约束；幂等请用业务去重表/唯一键。

  

- MessageId

  - 定义：Broker 存储后生成的 **物理定位 ID**（包含存储主机与物理偏移）；发送结果里可拿到。
  - 补充：客户端还会附带一个 UNIQ_KEY（全局唯一标识，用于追踪/去重层面提示）。
  - 易错：不同集群的 MessageId 不保证全局唯一；**物理定位用 MessageId，业务去重不要依赖它**。

  

- Offset（位点/偏移）

  - 三种常见语义：

    - **queueOffset**：逻辑位点（某 MessageQueue 内第 N 条）——**消费者提交/回溯使用**。
    - **commitLogOffset**：物理位点（CommitLog 字节偏移）——存储层定位用。
    - **pop/ack receipt**：POP 模式的“可见性票据”，**没有 queueOffset 提交**。

    

  - 易错：面试常混淆“queueOffset（消费提交）”与“commitLogOffset（物理）”。

  







# **3) 集群与命名（Cluster / BrokerName / BrokerId / Group）**

- Cluster（集群名）

  - 定义：Broker 的 **逻辑分组标签**（clusterName）。
  - 作用：路由可按集群维度组织/隔离（跨 IDC/多活时常用）；Console/运维按集群聚合展示与管理。
  - 易错：**Cluster ≠ Topic**；Topic 可以跨多个 Broker/集群部署策略需显式规划。

  

- BrokerName（Broker 组名）

  - 定义：同一主从复制组的 **逻辑名称**；一组内可含 1 个 Master + 若干 Slave，或一个 DLedger 复制组。
  - 作用：NameServer 路由以 BrokerName 聚合；消费者可从 Slave 读，生产通常写 Master/Leader。
  - 易错：顺序消费时，**同一 MessageQueue 固定在某 BrokerName 上**（跨 BrokerName 不保序）。

  

- BrokerId（Broker 标识）

  - 传统模式（主从）：0 = Master，>0 = Slave。
  - 新模式（DLedger/Controller/5.x）：引入 **Leader 选举**，对外语义更关注“Leader/Followers”，部分部署中弱化/替代固定 BrokerId 概念（以复制组/成员 ID 管理）。
  - 易错：答题要区分：**传统主从 vs DLedger 多副本**；不要一概而论“0=主，1=从”而忽略选主机制。

  

- Group（Producer/Consumer Group）

  - Producer Group

    - 作用：**事务消息回查的回调定位**（Broker 回查发给哪个 Producer Group 的任意存活实例）；也用于权限/统计维度。
    - 易错：**与分片/路由无关**；同一业务通常一个 Producer Group 即可。

    

  - Consumer Group

    - 作用：定义消费行为的 **逻辑消费者**（Cluster/Broadcast、并发度、位点命名空间、重试与 DLQ 前缀）。

    - 重要派生：

      - 重试主题：%RETRY%{Group}（Cluster 模式）。
      - 死信主题：%DLQ%{Group}。
      - 位点：以「Topic + Queue + Group」三元组唯一。

      

    - 易错：**同一 Group 下多个实例会分摊队列**（Cluster）；Broadcast 模式**每个实例都全量消费**且位点多为本地。

    

  





## **小结版“口袋答案”（速背）**

- **顺序只在单个 MessageQueue 内保证**；固定分片（ShardingKey→queue）+ 单线程消费。
- **MessageId** 用来定位存储；**UNIQ_KEY** 用来业务追踪；**Key** 用来按业务键查询。
- **queueOffset** 是消费者提交的逻辑位点；**commitLogOffset** 是物理存储位点；POP 没位点，靠 ACK 票据。
- **NameServer** 只是路由注册表；客户端有本地路由缓存。
- **Producer Group** 用于事务回查；**Consumer Group** 决定分摊/位点/重试与 DLQ 命名。
- 主从时代 BrokerId=0 表示 Master；**DLedger/5.x 更关注 Leader 角色**（别把两代机制混为一谈）。
- **Proxy（5.x）** 是接入层，做协议/安全/连接汇聚与 POP/TIMER 协议卸载，并非路由中心。